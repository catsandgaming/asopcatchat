<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cat Cafe Autonomous Chat Simulator</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        // Custom colors based on the Cafe Cat theme
                        'cat-purple': '#8B5CF6',
                        'cat-pink': '#EC4899',
                        'cat-owner': '#34D399', // Emerald for the Owner
                        'cat-background': '#f7f7f7',
                        'cat-text': '#1f2937',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--tw-colors-cat-background);
            min-height: 100vh;
        }
        .chat-container-main {
            height: calc(100vh - 150px); /* Adjust height for main content area */
            overflow-y: auto;
            max-width: 800px;
            margin: 0 auto;
        }
        .chat-bubble {
            border-radius: 1rem;
            padding: 0.75rem 1.25rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        /* Custom formatting for cat/owner names in dialogue */
        .cat-name {
            font-weight: 800; /* Extra bold */
            color: var(--tw-colors-cat-purple);
        }
        .owner-name {
            font-weight: 800;
            color: var(--tw-colors-cat-owner); /* Green for Owner */
        }
        .input-area {
            position: sticky;
            bottom: 0;
            background-color: white;
            padding: 1rem;
            border-top: 1px solid #e5e7eb;
            box-shadow: 0 -4px 6px -1-2px rgb(0 0 0 / 0.1);
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- Header -->
    <header class="bg-cat-purple shadow-xl p-4 md:p-6 sticky top-0 z-10">
        <div class="max-w-4xl mx-auto flex justify-center items-center">
            <h1 class="text-xl md:text-3xl font-extrabold text-white flex items-center">
                <span class="inline-block mr-2 text-2xl md:text-4xl">üêà</span> A Slice Of Purrfection Cat Chat!
            </h1>
            <!-- The Manage Cats button has been removed and replaced by the URL fragment check -->
        </div>
        <p class="text-sm text-white text-center mt-1">
            Running on the **Gemini API** - hoping the environment security issue is resolved!
        </p>
        <p id="status-display" class="text-xs text-white/70 text-center mt-1 font-mono">Loading...</p>
    </header>

    <!-- Main Chat Window -->
    <main class="flex-grow p-4 pb-0 md:p-6 md:pb-0 chat-container-main">
        <div id="chat-window" class="space-y-4">
            <!-- Messages will be injected here -->
            <div id="initial-message" class="flex justify-center my-8">
                <div class="text-center chat-bubble bg-white border border-cat-purple/30 max-w-sm">
                    <p class="font-semibold text-gray-700 mb-2">Simulation Ready</p>
                    <p class="text-sm text-gray-500">Waiting for you to start the discussion.</p>
                </div>
            </div>
            <div id="loading-spinner" class="hidden flex justify-center py-8">
                <svg class="animate-spin h-8 w-8 text-cat-purple" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </div>
        </div>
    </main>

    <!-- Input/Control Area -->
    <div class="input-area">
        <div class="max-w-4xl mx-auto flex flex-col space-y-3">
            <input 
                type="text" 
                id="initial-prompt" 
                placeholder="Enter the initial scene/topic here (e.g., A customer just ordered a tuna sandwich)."
                value="The cafe just replaced the old, worn-out scratching post with a new, very modern, pastel-pink cat tower."
                class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-cat-purple text-cat-text"
                onkeydown="if(event.key === 'Enter' && !isSending) document.getElementById('start-button').click()">
            
            <button id="start-button" onclick="startChat()" disabled
                    class="w-full bg-cat-purple hover:bg-cat-pink text-white font-semibold py-3 px-5 rounded-lg transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed text-lg">
                Start Chat
            </button>
        </div>
    </div>

    <!-- Password Prompt Modal -->
    <div id="password-modal" class="fixed inset-0 bg-black bg-opacity-80 z-[60] hidden flex items-center justify-center transition-opacity duration-300">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-auto p-6 md:p-8 transform transition-transform scale-95">
            <h2 class="text-2xl font-bold text-cat-purple mb-4 text-center">Owner Access Required</h2>
            <p class="text-center text-gray-600 mb-6">Enter the owner password to access the Cat Profile Manager.</p>
            <form id="password-form" onsubmit="handlePasswordSubmit(event)">
                <input type="password" id="manager-password" placeholder="Password" required
                    class="w-full p-3 border-2 border-gray-300 rounded-lg focus:ring-cat-pink focus:border-cat-pink text-center text-lg">
                <p id="password-error" class="text-red-500 text-sm mt-2 text-center hidden">Incorrect password.</p>
                <button type="submit" class="w-full bg-cat-pink hover:bg-cat-purple text-white font-bold py-3 mt-5 rounded-lg transition duration-300 shadow-lg">
                    Unlock Manager
                </button>
            </form>
            <div class="text-center mt-4">
                 <a href="#" onclick="window.location.hash='';" class="text-sm text-gray-500 hover:text-cat-purple transition">Cancel</a>
            </div>
        </div>
    </div>


    <!-- Cat Manager Modal -->
    <div id="cat-manager-modal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden overflow-y-auto p-4 transition-opacity duration-300">
        <!-- Modal Content -->
        <div class="bg-white rounded-xl shadow-2xl max-w-4xl mx-auto my-8 p-6 md:p-8">
            <div class="flex justify-between items-center border-b pb-4 mb-6">
                <h2 class="text-2xl font-bold text-cat-purple">Cat Profile Manager</h2>
                <!-- Close button now clears the URL hash -->
                <button onclick="window.location.hash='';" class="text-gray-400 hover:text-cat-pink transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <!-- Add New Cat Form -->
            <h3 class="text-xl font-semibold text-gray-700 mb-3">Add / Edit Cat Profile</h3>
            <form id="cat-form" class="grid grid-cols-1 md:grid-cols-2 gap-4 border p-4 rounded-lg mb-4 bg-gray-50">
                <input type="hidden" id="cat-id-input" value="">

                <input type="text" id="cat-name-input" placeholder="Name (e.g., Whiskers)" required
                    class="col-span-1 md:col-span-2 p-3 border border-gray-300 rounded-lg focus:ring-cat-pink focus:border-cat-pink">
                
                <input type="text" id="cat-breed-input" placeholder="Breed (e.g., Siamese)" required
                    class="p-3 border border-gray-300 rounded-lg focus:ring-cat-pink focus:border-cat-pink">
                
                <input type="text" id="cat-likes-input" placeholder="Likes (comma separated, e.g., Sunbeams, Cuddles)" required
                    class="p-3 border border-gray-300 rounded-lg focus:ring-cat-pink focus:border-cat-pink">
                
                <textarea id="cat-personality-input" placeholder="Personality (e.g., Moody but lovable lap cat)" required
                    class="col-span-1 md:col-span-2 p-3 border border-gray-300 rounded-lg focus:ring-cat-pink focus:border-cat-pink"></textarea>

                <button type="submit" class="col-span-1 md:col-span-2 bg-cat-pink hover:bg-cat-purple text-white font-bold py-3 rounded-lg transition duration-300 shadow-lg">
                    <span id="form-button-text">Add New Cat</span>
                </button>
            </form>
            <!-- NEW: Status Message for CRUD operations -->
            <p id="cat-form-status" class="text-center font-semibold mb-4 hidden"></p>

            <!-- Current Cat Profiles List -->
            <h3 class="text-xl font-semibold text-gray-700 mb-3">Current Cat Profiles (<span id="cat-count">0</span>)</h3>
            <div id="cat-list-container" class="space-y-4">
                <!-- Cat profiles will be dynamically rendered here -->
                <p id="no-cats-message" class="text-center text-gray-500 py-6 border-dashed border-2 rounded-lg">No cat profiles found in the database. Please add one!</p>
            </div>

        </div>
    </div>


    <!-- Firebase & Gemini API Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, setLogLevel, doc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Environment Globals ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // --- State Variables ---
        let db = null;
        let auth = null;
        window.cats = []; 
        let characters = []; 
        let chatHistory = []; 
        let isReady = false;
        let isSending = false;
        let chatStarted = false;
        let authReady = false; 
        let configMissing = false; 
        let isManaging = false; 

        // Character List (The Owner is defined here)
        const OWNER_PROFILE = {
            name: "Owner",
            breed: "Human",
            personality: "Caring, busy, slightly exasperated, focused on cafe operations and keeping the cats happy (and off the tables).",
            likes: ["Happy cats", "Coffee", "Quiet afternoons"],
            dislikes: ["Vet visits", "Knocked-over food displays"]
        };

        // Manager Password (Hardcoded for simplicity in this single-file app)
        const MANAGER_PASSWORD = "ownerpass";
        
        // --- DOM Elements ---
        const chatWindow = document.getElementById('chat-window');
        const initialPromptInput = document.getElementById('initial-prompt');
        const startButton = document.getElementById('start-button');
        const statusDisplay = document.getElementById('status-display');
        const loadingSpinner = document.getElementById('loading-spinner');
        const initialMessage = document.getElementById('initial-message');

        // Cat Manager DOM Elements
        const managerModal = document.getElementById('cat-manager-modal');
        const catListContainer = document.getElementById('cat-list-container');
        const catForm = document.getElementById('cat-form');
        const catCountSpan = document.getElementById('cat-count');
        const formButtonText = document.getElementById('form-button-text');
        const noCatsMessage = document.getElementById('no-cats-message');
        const catFormStatus = document.getElementById('cat-form-status'); // New status element
        
        // Password Modal DOM Elements
        const passwordModal = document.getElementById('password-modal');
        const passwordInput = document.getElementById('manager-password');
        const passwordError = document.getElementById('password-error');
        
        // Gemini API Endpoint (Reverted to the functional API)
        const GEMINI_API_KEY = ""; // Key is injected by the environment
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;

        // --- Utility Functions ---

        /**
         * Builds a detailed system instruction for the autonomous chat simulation.
         */
        function buildSystemInstruction(topic) {
            let instruction = "You are the autonomous script generator for a Cat Cafe Simulation. The characters are " + window.cats.length + " cats and their Owner. ";
            instruction += "Your task is to generate the **next turn of the conversation** among 2 to 4 of these characters based on the topic and the current dialogue history. ";
            instruction += "The conversation should be dynamic, realistic, and reflect each character's established personality. The cat characters are: " + window.cats.map(c => c.name).join(', ') + ".\n\n";
            instruction += "--- RULES ---\n";
            instruction += "1. The current topic is: " + topic + "\n";
            instruction += "2. Format the entire response as a single block of dialogue using the format 'CharacterName: [Dialogue]'. Use newline characters for multiple speakers in one turn.\n";
            instruction += "3. The simulation continues until the conversation naturally concludes or hits an amusing stopping point.\n";
            instruction += "4. Do NOT include any introductory or concluding text (e.g., 'Next turn...', 'The conversation continues...'). Just output the raw dialogue.\n";
            instruction += "--- CHARACTER PROFILES ---\n";

            characters.forEach(char => {
                const likes = char.likes.join(", ");
                const dislikes = char.dislikes && char.dislikes.length > 0 ? ` (Dislikes: ${char.dislikes.join(", ")})` : '';
                instruction += `- ${char.name} (${char.breed}): ${char.personality}. Loves: ${likes}.${dislikes}\n`;
            });
            
            if (chatHistory.length === 0) {
                instruction += "\nBegin the simulation by having the characters immediately reacting to the initial topic/scene.";
            } else {
                instruction += "\nGenerate the next turn of dialogue by having the characters respond to the previous turn and move the discussion forward.";
            }

            return instruction;
        }

        /**
         * Renders a message bubble in the chat window.
         */
        function renderMessage(text) {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = 'flex justify-start w-full';
            
            const messageBubble = document.createElement('div');
            messageBubble.className = 'max-w-4xl chat-bubble mt-2 bg-white text-cat-text border border-gray-200 shadow-md whitespace-pre-wrap';
            messageBubble.innerHTML = formatDialogue(text);

            messageWrapper.appendChild(messageBubble);
            chatWindow.appendChild(messageBubble);
            chatWindow.scrollTop = chatWindow.scrollHeight; 
        }

        /**
         * Formats the cat dialogue by highlighting names.
         */
        function formatDialogue(text) {
             // Regex to find 'CharacterName: ' at the start of a line or after a newline
            const charNames = characters.map(c => c.name).join('|');
            const dialogueRegex = new RegExp(`(^|\\n)(${charNames}): (.*)`, 'g');
            
            return text.replace(dialogueRegex, (match, p1, name, dialogue) => {
                const nameClass = name === 'Owner' ? 'owner-name' : 'cat-name';
                return `${p1}<span class="${nameClass}">${name}:</span> ${dialogue}`;
            });
        }
        
        /**
         * Makes a robust API call with exponential backoff.
         */
        async function fetchWithRetry(url, options, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status !== 429) { 
                        return response;
                    }
                    console.warn(`Rate limit hit (429). Retrying in ${2 ** i} seconds...`);
                } catch (error) {
                    console.error("Fetch error during attempt", i + 1, error);
                }
                await new Promise(resolve => setTimeout(resolve, (2 ** i) * 1000));
            }
            throw new Error("API call failed after multiple retries.");
        }


        // --- Firebase Initialization and Data Fetching ---

        function initializeFirebase() {
            let configToUse = firebaseConfig;
            configMissing = Object.keys(firebaseConfig).length === 0;

            if (configMissing) {
                // Use a dummy config to prevent initializeApp from crashing 
                configToUse = { 
                    apiKey: "DUMMY", 
                    authDomain: "DUMMY.firebaseapp.com", 
                    projectId: "DUMMY", 
                    storageBucket: "DUMMY.appspot.com", 
                    messagingSenderId: "DUMMY", 
                    appId: "DUMMY" 
                };
                statusDisplay.textContent = "‚ö†Ô∏è WARNING: Config Missing. Data cannot be loaded. Run in Canvas editor.";
                console.warn("Using dummy Firebase config. Database functionality is disabled.");
            } else {
                statusDisplay.textContent = "Initializing...";
            }

            try {
                setLogLevel('debug');
                
                const app = initializeApp(configToUse);
                db = getFirestore(app);
                auth = getAuth(app);
                
                if (configMissing) {
                    loadPlaceholderCats();
                    startButton.disabled = false;
                    checkUrlHash(); 
                    return;
                }

                const authPromise = initialAuthToken 
                    ? signInWithCustomToken(auth, initialAuthToken)
                    : signInAnonymously(auth);

                authPromise.catch(e => {
                    console.error("Authentication sign-in failed:", e.message);
                    statusDisplay.textContent = "Error: Failed to sign in. Check console for details.";
                });
                
                const unsubscribe = onAuthStateChanged(auth, (user) => {
                    if (user && !authReady) {
                        authReady = true;
                        console.log("Authentication successful. UID:", user.uid);
                        fetchCats();
                        checkUrlHash(); 
                        unsubscribe();
                    } 
                });
                
                // Listen for hash changes (e.g., user manually types or removes #/manage-cats)
                window.addEventListener('hashchange', checkUrlHash);


            } catch (error) {
                console.error("Firebase initialization error:", error);
                statusDisplay.textContent = `Error initializing: ${error.message}`;
            }
        }
        
        // Fallback cat data for when config is missing
        function loadPlaceholderCats() {
            // Using a simple index as a temporary ID for placeholder data
            window.cats = [
                { id: "ronnie-p", name: "Ronnie", breed: "Siamese", personality: "Vocal and demanding, often complaining about the service.", likes: ["Attention", "Warm spots"], dislikes: ["Loud noises"] },
                { id: "jigsaw-p", name: "Jigsaw", breed: "Tabby", personality: "Adept at puzzles, often found staring intently at objects.", likes: ["Feather toys", "Quiet observation"], dislikes: ["Being rushed"] },
                { id: "bear-p", name: "Bear", breed: "Maine Coon", personality: "Large and gentle, but a clumsy bully who pushes smaller cats.", likes: ["Cuddles", "Big naps"], dislikes: ["Small spaces"] },
                { id: "jet-p", name: "Jet", breed: "Black Cat", personality: "Sleek and mysterious, spends most of its time watching birds.", likes: ["High places", "Shadows"], dislikes: ["Bright lights"] },
                { id: "shadow-p", name: "Shadow", breed: "Sphynx", personality: "Naked and perpetually cold, constantly seeking warmth from customers or appliances.", likes: ["Sweaters", "Heat vents"], dislikes: ["Cold air"] },
                { id: "thor-p", name: "Thor", breed: "Ragdoll", personality: "Sweet and floppy, but has a dramatic flair for 'fainting' when picked up.", likes: ["Belly rubs", "Soft blankets"], dislikes: ["Being held tightly"] },
                { id: "marble-p", name: "Marble", breed: "Calico", personality: "A true diva, highly photogenic, and knows it. Demands the best sunbeams.", likes: ["Cameras", "Sunbeams"], dislikes: ["Being ignored"] },
                { id: "banjo-p", name: "Banjo", breed: "Munchkin", personality: "Short-legged and perpetually playful, always tripping over its own feet.", likes: ["Laser pointers", "Chasing dust"], dislikes: ["Stairs"] },
                { id: "button-p", name: "Button", breed: "Scottish Fold", personality: "Sweetest cat in the cafe, but prone to anxiety. Hides behind the register.", likes: ["Owner", "Inside boxes"], dislikes: ["New people"] },
                { id: "dash-p", name: "Dash", breed: "Bengal", personality: "High-energy and athletic, constantly running laps around the tables.", likes: ["Running", "Climbing"], dislikes: ["Sitting still"] }
            ];
            characters = [...window.cats, OWNER_PROFILE];
            isReady = true;
            startButton.disabled = false;
            statusDisplay.textContent = "‚ö†Ô∏è WARNING: Using placeholder data. Ready to start!";
        }


        function fetchCats() {
            if (configMissing) {
                // In case placeholder data is used, ensure we call renderCatList if the manager is active
                if (isManaging) renderCatList();
                return;
            }
            if (!db) {
                console.error("Firestore database instance is not available.");
                statusDisplay.textContent = "Database not initialized.";
                return;
            }
            
            // Public collection path: /artifacts/{appId}/public/data/cats
            const catCollectionPath = `artifacts/${appId}/public/data/cats`;
            const q = query(collection(db, catCollectionPath));

            onSnapshot(q, (querySnapshot) => {
                window.cats = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.name) {
                        // CRITICAL: Store the document ID with the data
                        window.cats.push({ id: doc.id, ...data });
                    }
                });

                characters = [...window.cats, OWNER_PROFILE];

                if (window.cats.length >= 1) { 
                    isReady = true;
                    startButton.disabled = false;
                    statusDisplay.textContent = `${window.cats.length} Cat Profiles + Owner Loaded. Ready to start!`;
                    console.log(`All ${window.cats.length + 1} character profiles loaded successfully.`);
                } else {
                    statusDisplay.textContent = `Loading cat profiles (0 found)... Please use the Importer!`;
                    isReady = false; 
                    startButton.disabled = true;
                }
                
                // If the manager is open, re-render the list automatically after changes
                if (isManaging) {
                     renderCatList(); 
                }

            }, (error) => {
                console.error("Error fetching cat data:", error);
                statusDisplay.textContent = "Error loading cat data: Missing or insufficient permissions. Run the data importer!";
            });
        }
        
        // --- ROUTING/MANAGER ACCESS FUNCTIONS ---

        function checkUrlHash() {
            if (window.location.hash === '#/manage-cats') {
                if (!isManaging) {
                    showPasswordPrompt();
                }
            } else {
                hidePasswordPrompt();
                toggleCatManager(false); // Close the manager if the hash is cleared
            }
        }

        function showPasswordPrompt() {
            passwordModal.classList.remove('hidden');
            passwordInput.focus();
        }

        function hidePasswordPrompt() {
            passwordModal.classList.add('hidden');
            passwordInput.value = '';
            passwordError.classList.add('hidden');
        }

        window.handlePasswordSubmit = function(event) {
            event.preventDefault();
            const enteredPassword = passwordInput.value;
            
            if (enteredPassword === MANAGER_PASSWORD) {
                hidePasswordPrompt();
                toggleCatManager(true);
            } else {
                passwordError.classList.remove('hidden');
                passwordInput.value = '';
                passwordInput.focus();
            }
        }


        // Reusable function to open/close the manager modal based on state
        function toggleCatManager(open) {
            isManaging = open;
            if (open) {
                managerModal.classList.remove('hidden');
                renderCatList(); 
                resetCatForm();
            } else {
                managerModal.classList.add('hidden');
            }
        }

        window.loadCatForEdit = function(cat) {
            document.getElementById('cat-id-input').value = cat.id;
            document.getElementById('cat-name-input').value = cat.name;
            document.getElementById('cat-breed-input').value = cat.breed;
            // Join the array of likes into a comma-separated string for the input field
            document.getElementById('cat-likes-input').value = cat.likes.join(', ');
            document.getElementById('cat-personality-input').value = cat.personality;
            formButtonText.textContent = `Update ${cat.name}`;
            managerModal.scrollTop = 0; // Scroll to the top to show the form
        }

        function resetCatForm() {
            document.getElementById('cat-id-input').value = '';
            document.getElementById('cat-name-input').value = '';
            document.getElementById('cat-breed-input').value = '';
            document.getElementById('cat-likes-input').value = '';
            document.getElementById('cat-personality-input').value = '';
            formButtonText.textContent = "Add New Cat";
            catFormStatus.classList.add('hidden'); // Also hide status on reset
        }

        window.deleteCat = async function(catId, catName) {
            if (!authReady || configMissing || !db) {
                console.error("Cannot delete: Database not connected or user not authenticated.");
                return;
            }

            // Custom confirmation prompt
            if (prompt(`Type 'DELETE' to confirm you want to remove ${catName} permanently.`) !== 'DELETE') {
                 console.log("Deletion cancelled.");
                 return;
            }

            try {
                const catDocRef = doc(db, `artifacts/${appId}/public/data/cats`, catId);
                await deleteDoc(catDocRef);
                console.log(`Cat ${catName} deleted successfully.`);
            } catch (error) {
                console.error(`Error deleting cat ${catName}:`, error);
            }
        }

        function renderCatList() {
            catListContainer.innerHTML = ''; // Clear previous list
            catCountSpan.textContent = window.cats.length;

            if (window.cats.length === 0) {
                noCatsMessage.classList.remove('hidden');
                return;
            } else {
                noCatsMessage.classList.add('hidden');
            }

            window.cats.forEach(cat => {
                const catElement = document.createElement('div');
                catElement.className = 'flex flex-col md:flex-row justify-between items-start md:items-center p-4 bg-white border border-gray-200 rounded-lg shadow-sm';
                
                // Get a truncated personality description
                const personalitySnippet = cat.personality.length > 50 
                    ? cat.personality.substring(0, 50).trim() + '...' 
                    : cat.personality;

                catElement.innerHTML = `
                    <div>
                        <p class="text-lg font-bold text-cat-purple">${cat.name}</p>
                        <p class="text-sm text-gray-600">${cat.breed} - ${personalitySnippet}</p>
                        <p class="text-xs text-gray-500 mt-1">Likes: ${cat.likes.join(', ')}</p>
                    </div>
                    <div class="flex space-x-2 mt-3 md:mt-0">
                        <button onclick="loadCatForEdit(window.cats.find(c => c.id === '${cat.id}'))" class="text-sm text-cat-owner hover:text-green-700 font-semibold transition">Edit</button>
                        <button onclick="deleteCat('${cat.id}', '${cat.name}')" class="text-sm text-red-500 hover:text-red-700 font-semibold transition">Delete</button>
                    </div>
                `;
                catListContainer.appendChild(catElement);
            });
        }

        // Global submit handler for the form
        catForm.addEventListener('submit', handleCatFormSubmit);

        async function handleCatFormSubmit(event) {
            event.preventDefault();
            catFormStatus.classList.add('hidden'); // Hide any previous status

            if (!authReady || configMissing || !db) {
                console.error("Operation failed: Database not connected or user not authenticated.");
                catFormStatus.textContent = "Error: Database is not ready. Check initialization status.";
                catFormStatus.classList.remove('hidden', 'text-cat-owner');
                catFormStatus.classList.add('text-red-500');
                return;
            }

            // Use crypto.randomUUID() for new documents, or the existing ID for updates
            const id = document.getElementById('cat-id-input').value.trim() || crypto.randomUUID();
            const name = document.getElementById('cat-name-input').value.trim();
            const breed = document.getElementById('cat-breed-input').value.trim();
            const personality = document.getElementById('cat-personality-input').value.trim();
            const likesString = document.getElementById('cat-likes-input').value.trim();
            
            // Simple parsing of comma-separated likes
            const likes = likesString.split(',').map(item => item.trim()).filter(item => item.length > 0);

            const catData = {
                name: name,
                breed: breed,
                personality: personality,
                likes: likes,
                dislikes: [], 
                is_featured: false 
            };

            const isEditing = !!document.getElementById('cat-id-input').value.trim();

            try {
                const catDocRef = doc(db, `artifacts/${appId}/public/data/cats`, id);
                await setDoc(catDocRef, catData); // setDoc handles both creation and updating based on the ID

                const successMessage = `${isEditing ? 'Updated' : 'Added'} **${name}** successfully!`;
                console.log(successMessage.replace(/\*\*/g, ''));
                
                // Display success message
                catFormStatus.innerHTML = successMessage;
                catFormStatus.classList.remove('hidden', 'text-red-500');
                catFormStatus.classList.add('text-cat-owner'); // Green for success
                
                resetCatForm();
                // The onSnapshot listener will fire and call renderCatList()

                // Hide status message after 3 seconds
                setTimeout(() => catFormStatus.classList.add('hidden'), 3000);

            } catch (error) {
                console.error(`Error saving cat data:`, error);
                // Display error message
                catFormStatus.textContent = `Failed to save ${name}: ${error.message}. Check console for details.`;
                catFormStatus.classList.remove('hidden', 'text-cat-owner');
                catFormStatus.classList.add('text-red-500');
            }
        }
        
        // --- Simulation Logic ---

        window.startChat = async function() {
            if (!isReady || isSending) return;

            const topic = initialPromptInput.value.trim();
            if (!topic) return;

            initialMessage.classList.add('hidden');
            
            if (!chatStarted) {
                // Initialize for the first turn 
                chatHistory = [];
                // The first user message is the scene setup
                chatHistory.push({ role: "user", parts: [{ text: "Initial Scene/Topic: " + topic }] });
                chatStarted = true;
                initialPromptInput.disabled = true;

                // Change button text and function
                startButton.textContent = "Next Turn";
                startButton.onclick = window.generateNextTurn;

                renderMessage(`**SIMULATION START** - Topic: ${topic}`);
            }

            // Immediately generate the first turn
            window.generateNextTurn();
        }

        window.generateNextTurn = async function() {
            if (!isReady || isSending) return;

            const topic = initialPromptInput.value.trim();
            
            isSending = true;
            startButton.disabled = true;
            loadingSpinner.classList.remove('hidden');

            const systemPrompt = buildSystemInstruction(topic);

            const payload = {
                contents: chatHistory,
                // System instructions are optional but recommended for guiding the model's persona and response format.
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                // Setting temperature for creativity
                config: {
                    temperature: 0.8
                }
            };
            
            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
                // Attempt to fix cross-origin issues
                mode: 'cors' 
            };

            // Call API and Handle Response
            try {
                const response = await fetchWithRetry(GEMINI_API_URL, options);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    // Throw a clean error with status and the response body snippet
                    throw new Error(`API returned status ${response.status}.`);
                }

                const result = await response.json();
                
                // Extract text from Gemini response structure
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (text) {
                    // Display model message and update history
                    renderMessage(text);
                    // Store the response in the local history using the 'model' role
                    chatHistory.push({ role: "model", parts: [{ text: text }] });
                } else {
                    renderMessage("The simulation hit a wall. All characters are napping. Click 'Next Turn' to try waking them.");
                    console.error("Gemini API response missing text content or candidates:", result);
                }

            } catch (error) {
                console.error("Gemini API error:", error);
                
                // Handle the 403 error specifically
                if (error.message.includes("403")) {
                    renderMessage(`**System Alert: Connection Blocked.** The conversation is temporarily paused because of a security restriction on the network. Please try again later.`);
                } else {
                    // General network failure
                    renderMessage(`Error: The network connection failed. (${error.message})`);
                }

            } finally {
                // Cleanup
                isSending = false;
                startButton.disabled = false;
                loadingSpinner.classList.add('hidden');
                chatWindow.scrollTop = chatWindow.scrollHeight; 
            }
        };


        // --- Initialization on Load ---
        window.onload = initializeFirebase;
    </script>
</body>
</html>
