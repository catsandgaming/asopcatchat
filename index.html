<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Persistent Cat Profile Manager</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, setDoc, deleteDoc, query, where, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set Firebase log level for debugging
        setLogLevel('Debug');

        // --- Global Variables (Canvas Environment) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-cat-app';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let userId = 'anonymous'; // Default until auth is complete
        let isAuthReady = false;

        // Initial placeholder data (used only to populate Firestore on first run)
        const MOCK_CAT_DATA = [
            { name: "Ronnie", breed: "Siamese", description: "Vocal and demanding, often complaining about the smallest things.", likes: "Attention, Warm spots" },
            { name: "Jigsaw", breed: "Tabby", description: "Adept at puzzles, often found staring intently at walls.", likes: "Feather toys, Quiet observation" },
            { name: "Bear", breed: "Maine Coon", description: "Large and gentle, but a clumsy bully who pushes smaller toys.", likes: "Cuddles, Big naps" },
            { name: "Jet", breed: "Black Cat", description: "Sleek and mysterious, spends most of its time watching birds.", likes: "High places, Shadows" },
            { name: "Shadow", breed: "Sphynx", description: "Naked and perpetually cold, constantly seeking warm laps.", likes: "Sweaters, Heat vents" },
            { name: "Thor", breed: "Ragdoll", description: "Sweet and floppy, but has a dramatic flair for 'fainting'.", likes: "Belly rubs, Soft blankets" },
            { name: "Marble", breed: "Calico", description: "A true diva, highly photogenic, and knows it. Demands the best spots.", likes: "Cameras, Sunbeams" },
            { name: "Banjo", breed: "Munchkin", description: "Short-legged and perpetually playful, always tripping over air.", likes: "Laser pointers, Chasing dust" },
            { name: "Button", breed: "Scottish Fold", description: "Sweetest cat in the cafe, but prone to anxiety. Hides inside boxes.", likes: "Owner, Inside boxes" },
            { name: "Dash", breed: "Bengal", description: "High-energy and athletic, constantly running laps and climbing.", likes: "Running, Climbing" }
        ];

        // --- DOM Elements ---
        const catListContainer = document.getElementById('cat-list-container');
        const formTitle = document.getElementById('form-title');
        const catForm = document.getElementById('cat-form');
        const formMessage = document.getElementById('form-message');
        const nameInput = document.getElementById('cat-name');
        const breedInput = document.getElementById('cat-breed');
        const descInput = document.getElementById('cat-description');
        const likesInput = document.getElementById('cat-likes');
        let currentEditingId = null;

        // --- Utility Functions ---

        /**
         * Generates the Firestore collection path for public (shared) data.
         * @returns {string} The Firestore collection path.
         */
        function getCatCollectionPath() {
            // Using a public path so all users see the same cafe cats
            return `artifacts/${appId}/public/data/cat_profiles`;
        }

        /**
         * Populates Firestore with mock data if the collection is empty.
         */
        async function checkAndPopulateInitialData() {
            try {
                const catCollection = collection(db, getCatCollectionPath());
                const querySnapshot = await getDocs(catCollection);

                if (querySnapshot.empty) {
                    console.log("Collection is empty. Populating with mock data...");
                    for (const cat of MOCK_CAT_DATA) {
                        await addDoc(catCollection, cat);
                    }
                    console.log("Mock data populated successfully.");
                } else {
                    console.log(`Collection already contains ${querySnapshot.size} cats. Skipping mock data population.`);
                }
            } catch (error) {
                console.error("Error checking or populating initial data:", error);
            }
        }

        /**
         * Renders the list of cat profiles from the database.
         * @param {Array<Object>} cats - The array of cat objects from Firestore.
         */
        function renderCatProfiles(cats) {
            catListContainer.innerHTML = ''; // Clear existing list
            
            // Display User ID for reference
            const userIdDisplay = document.createElement('div');
            userIdDisplay.className = 'text-xs text-cat-purple font-mono mb-4 p-2 bg-purple-100 rounded-lg';
            userIdDisplay.textContent = `User ID: ${userId}`;
            catListContainer.appendChild(userIdDisplay);

            const countHeader = document.createElement('h2');
            countHeader.className = 'text-2xl font-bold mb-4 text-cat-text';
            countHeader.textContent = `Current Cat Profiles (${cats.length})`;
            catListContainer.appendChild(countHeader);


            if (cats.length === 0) {
                catListContainer.innerHTML += '<p class="text-gray-500">No cat profiles found. Add one!</p>';
                return;
            }

            cats.forEach(cat => {
                const card = document.createElement('div');
                card.id = `cat-${cat.id}`;
                card.className = 'bg-white p-4 rounded-xl shadow-lg hover:shadow-xl transition duration-300 mb-4 border border-gray-100';
                card.innerHTML = `
                    <div class="flex items-start justify-between">
                        <div>
                            <h3 class="text-xl font-extrabold text-cat-purple">${cat.name}</h3>
                            <p class="text-sm font-semibold text-gray-700 mt-1">${cat.breed} - ${cat.description}</p>
                            <p class="text-xs text-gray-500 mt-2">
                                <span class="font-bold">Likes:</span> ${cat.likes}
                            </p>
                        </div>
                        <div class="flex space-x-2 mt-1">
                            <button data-id="${cat.id}" data-action="edit" class="edit-btn bg-cat-owner text-white text-xs font-semibold px-3 py-1 rounded-full hover:bg-emerald-600 transition shadow-md">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline mr-1" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zm-5.646 12.828l-.793.793-2.828-2.828.793-.793 2.828 2.828z" />
                                    <path fill-rule="evenodd" d="M14.586 4.586a2 2 0 013 3l-1.414 1.414-3-3L14.586 4.586zM3 13.586l.793.793 2.828 2.828-.793.793a2 2 0 01-3-3z" clip-rule="evenodd" />
                                </svg>
                                Edit
                            </button>
                            <button data-id="${cat.id}" data-action="delete" class="delete-btn bg-red-500 text-white text-xs font-semibold px-3 py-1 rounded-full hover:bg-red-600 transition shadow-md">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline mr-1" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 112 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                                </svg>
                                Delete
                            </button>
                        </div>
                    </div>
                `;
                catListContainer.appendChild(card);
            });
            // Attach event listeners after rendering
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', (e) => editCatHandler(e.currentTarget.dataset.id));
            });
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => deleteCat(e.currentTarget.dataset.id, e.currentTarget.closest('.cat-card')));
            });
        }

        /**
         * Loads a cat's data into the form for editing.
         * @param {string} catId - The ID of the cat document.
         */
        async function editCatHandler(catId) {
            try {
                const catDocRef = doc(db, getCatCollectionPath(), catId);
                const docSnapshot = await getDocs(query(collection(db, getCatCollectionPath()), where('__name__', '==', catId)));

                if (!docSnapshot.empty) {
                    const data = docSnapshot.docs[0].data();
                    currentEditingId = catId;
                    formTitle.textContent = `Update Profile: ${data.name}`;

                    nameInput.value = data.name || '';
                    breedInput.value = data.breed || '';
                    descInput.value = data.description || '';
                    likesInput.value = data.likes || '';

                    // Scroll to the form
                    catForm.scrollIntoView({ behavior: 'smooth' });
                } else {
                    showMessage('Cat not found in the database.', 'error');
                }
            } catch (error) {
                console.error("Error loading cat for edit:", error);
                showMessage('Failed to load cat data.', 'error');
            }
        }

        /**
         * Clears the form and resets the editing state.
         */
        function resetForm() {
            catForm.reset();
            currentEditingId = null;
            formTitle.textContent = 'Add New Cat Profile';
            formMessage.classList.add('hidden');
        }

        /**
         * Displays a temporary message above the form.
         * @param {string} message - The message text.
         * @param {'success'|'error'} type - The type of message.
         */
        function showMessage(message, type) {
            formMessage.textContent = message;
            formMessage.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700');
            if (type === 'error') {
                formMessage.classList.add('bg-red-100', 'text-red-700');
            } else {
                formMessage.classList.add('bg-green-100', 'text-green-700');
            }
            setTimeout(() => {
                formMessage.classList.add('hidden');
            }, 3000);
        }

        // --- Firestore CRUD Operations ---

        /**
         * Handles form submission to add a new cat or update an existing one.
         * @param {Event} e - The form submit event.
         */
        catForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const name = nameInput.value.trim();
            const breed = breedInput.value.trim();
            const description = descInput.value.trim();
            const likes = likesInput.value.trim();

            if (!name || !breed || !description) {
                showMessage("Please fill in the Cat's Name, Breed, and Description.", 'error');
                return;
            }

            const catData = { name, breed, description, likes };
            const catCollectionRef = collection(db, getCatCollectionPath());

            try {
                if (currentEditingId) {
                    // Update existing cat
                    const docRef = doc(catCollectionRef, currentEditingId);
                    await setDoc(docRef, catData, { merge: true });
                    showMessage(`Successfully updated ${name}'s profile!`, 'success');
                } else {
                    // Add new cat
                    await addDoc(catCollectionRef, catData);
                    showMessage(`Successfully added ${name} to the cafe!`, 'success');
                }
                resetForm();
            } catch (error) {
                console.error("Error saving cat profile:", error);
                showMessage('Failed to save profile. Check console for details.', 'error');
            }
        });

        /**
         * Deletes a cat profile from Firestore.
         * @param {string} catId - The ID of the document to delete.
         */
        async function deleteCat(catId) {
            if (!confirm(`Are you sure you want to delete this cat profile?`)) return;

            try {
                const docRef = doc(db, getCatCollectionPath(), catId);
                await deleteDoc(docRef);
                showMessage('Cat profile deleted successfully.', 'success');
            } catch (error) {
                console.error("Error deleting cat profile:", error);
                showMessage('Failed to delete profile. Check console for details.', 'error');
            }
        }

        /**
         * Sets up the real-time listener for the cat profiles collection.
         */
        function setupRealtimeListener() {
            if (!db || !isAuthReady) {
                console.warn("Firestore or Auth not ready. Skipping real-time listener setup.");
                return;
            }

            const catCollectionRef = collection(db, getCatCollectionPath());
            
            // onSnapshot provides real-time updates
            onSnapshot(catCollectionRef, (snapshot) => {
                const cats = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                renderCatProfiles(cats);
            }, (error) => {
                console.error("Realtime listener failed:", error);
                catListContainer.innerHTML = `<p class="text-red-500 font-bold p-4 bg-red-100 rounded-lg">Error loading cat profiles: ${error.message}</p>`;
            });

            // After setting up the listener, check if we need to populate initial data
            checkAndPopulateInitialData();
        }

        // --- Firebase Initialization ---

        async function initializeFirebase() {
            if (!firebaseConfig) {
                catListContainer.innerHTML = '<p class="text-red-500 font-bold p-4 bg-red-100 rounded-lg">Firebase Configuration is missing. Please run in a Canvas environment.</p>';
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // 1. Initial Authentication Check
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // 2. Auth State Listener (Crucial for setting userId)
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        console.log("Authenticated with user ID:", userId);
                        setupRealtimeListener(); // Start listening for data once auth is ready
                    } else {
                        userId = 'unauthenticated';
                        isAuthReady = false;
                        console.log("No user authenticated.");
                        // Handle unauthenticated state if needed (e.g., show read-only view)
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization/Authentication Error:", error);
                catListContainer.innerHTML = `<p class="text-red-500 font-bold p-4 bg-red-100 rounded-lg">Initialization Failed: ${error.message}</p>`;
            }
        }

        // Initialize Firebase on window load
        window.onload = initializeFirebase;
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
        }
    </style>
</head>
<body class="p-6 md:p-10 min-h-screen">
    <div class="max-w-4xl mx-auto">
        <header class="mb-8">
            <h1 class="text-4xl font-black text-cat-purple flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mr-3 text-cat-pink" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1 3 3 0 013.468 0 1 1 0 11-1.731 1.033A1 1 0 0010 7zm-5.632.54a1 1 0 011.085-1.787 6.002 6.002 0 0110.134 0 1 1 0 111.086 1.787A8.001 8.001 0 0010 2a8 8 0 00-5.632 5.54z" clip-rule="evenodd" />
                </svg>
                Cat Profile Manager
            </h1>
            <p class="text-gray-600 mt-2">Manage the cat profiles for the cafe in real-time. Changes are saved instantly!</p>
        </header>

        <!-- Cat Profile Form -->
        <div class="bg-white p-6 rounded-2xl shadow-xl mb-10 border-t-4 border-cat-pink">
            <h2 id="form-title" class="text-2xl font-bold mb-4 text-cat-text">Add New Cat Profile</h2>
            <div id="form-message" class="hidden p-3 mb-4 rounded-lg text-sm font-medium"></div>

            <form id="cat-form" class="space-y-4">
                <div>
                    <label for="cat-name" class="block text-sm font-medium text-gray-700">Name</label>
                    <input type="text" id="cat-name" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-cat-pink focus:ring-cat-pink p-3 border" placeholder="e.g., Ronnie">
                </div>
                <div>
                    <label for="cat-breed" class="block text-sm font-medium text-gray-700">Breed</label>
                    <input type="text" id="cat-breed" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-cat-pink focus:ring-cat-pink p-3 border" placeholder="e.g., Siamese">
                </div>
                <div>
                    <label for="cat-description" class="block text-sm font-medium text-gray-700">Description / Quirks</label>
                    <textarea id="cat-description" rows="2" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-cat-pink focus:ring-cat-pink p-3 border" placeholder="e.g., Vocal and demanding, often complaining about the smallest things."></textarea>
                </div>
                <div>
                    <label for="cat-likes" class="block text-sm font-medium text-gray-700">Likes (Comma Separated)</label>
                    <input type="text" id="cat-likes" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-cat-pink focus:ring-cat-pink p-3 border" placeholder="e.g., Attention, Warm spots">
                </div>
                <div class="flex space-x-4">
                    <button type="submit" class="w-full justify-center rounded-lg border border-transparent bg-cat-pink py-3 px-4 text-sm font-medium text-white shadow-md hover:bg-cat-purple focus:outline-none focus:ring-2 focus:ring-cat-pink focus:ring-offset-2 transition-transform transform hover:scale-[1.01]">
                        <span id="submit-text">Save Profile</span>
                    </button>
                    <button type="button" onclick="resetForm()" class="w-1/3 justify-center rounded-lg border border-gray-300 bg-white py-3 px-4 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition">
                        Reset
                    </button>
                </div>
            </form>
        </div>

        <!-- Cat Profiles List -->
        <div id="cat-list-container" class="space-y-4">
            <!-- Cat profiles will be dynamically loaded here by JavaScript -->
            <p class="text-center text-gray-500 p-4">Loading cat profiles from the database...</p>
        </div>
    </div>
</body>
</html>
